<h1>{{ pageContent.heading }}</h1>
<div class="mb-6 mb-md-7" [innerHtml]="pageContent.summary"></div>

<div *ngIf="showOverallError">
  <span>{{ overallErrorContent.heading }}</span>
  <span>{{ overallErrorContent.summary }}</span>
</div>
<form
  [formGroup]="form"
  (ngSubmit)="onSubmit()"
  class=""
  novalidate
  wesInvalidControlScroll
>
  <div class="form-group">
    <label for="honorific-prefix" data-test="lblTitle">{{
      pageContent.title.inputLabel
    }}</label>
    <select
      formControlName="title"
      name="honorific-prefix"
      class="form-control"
      data-test="ddTitle"
    >
      <option
        *ngFor="let title of titleList$ | async"
        value="{{ title.value }}"
        >{{ title.description }}</option
      >
    </select>

    <ng-container *ngIf="isFieldInvalid('title')">
      <span *ngIf="controls.title.errors.required">
        {{ pageContent.title.inputError }}
      </span>
    </ng-container>
  </div>
  <wes-form-field>
    <wes-label data-test="lblFirstName">{{
      pageContent.firstName.inputLabel
    }}</wes-label>
    <input
      wesInput
      type="text"
      formControlName="firstName"
      autocomplete="given-name"
      data-test="txtFirstName"
    />
    <wes-error *ngIf="isFieldInvalid('firstName')">
      <wes-form-field-error>
        {{ pageContent.firstName.inputError }}
      </wes-form-field-error>
    </wes-error>
  </wes-form-field>

  <wes-form-field>
    <wes-label data-test="lblLastName">{{
      pageContent.surname.inputLabel
    }}</wes-label>
    <input
      wesInput
      type="text"
      formControlName="lastName"
      autocomplete="family-name"
      data-test="txtLastName"
    />
    <wes-error *ngIf="isFieldInvalid('lastName')">
      <wes-form-field-error>{{
        pageContent.surname.inputError
      }}</wes-form-field-error></wes-error
    >
  </wes-form-field>

  <div class="form-group" formGroupName="dob">
    <label data-test="lblDoB">{{ pageContent.dob.inputLabel }}</label>
    <div class="">
      <wes-form-field class="dob-box dob-box-1">
        <input
          wesInput
          type="text"
          class="form-control col-sm-2"
          formControlName="day"
          inputmode="numeric"
          pattern="[0-9]*"
          name="bday-day"
          placeholder="DD"
          wesNumbersOnly
          maxlength="2"
          autocomplete="bday-day"
          data-test="txtDoBDay"
        />
      </wes-form-field>
      <wes-form-field class="dob-box dob-box-2 mx-2">
        <input
          wesInput
          type="text"
          class="form-control col-sm-2"
          formControlName="month"
          inputmode="numeric"
          pattern="[0-9]*"
          name="bday-month"
          placeholder="MM"
          wesNumbersOnly
          maxlength="2"
          autocomplete="bday-month"
          data-test="txtDoBMonth"
        />
      </wes-form-field>
      <wes-form-field class="dob-box dob-box-3">
        <input
          wesInput
          type="text"
          class="form-control col-sm-2"
          formControlName="year"
          inputmode="numeric"
          pattern="[0-9]*"
          name="bday-year"
          placeholder="YYYY"
          wesNumbersOnly
          maxlength="4"
          autocomplete="bday-year"
          data-test="txtDoBYear"
        />
      </wes-form-field>
    </div>
    <wes-error *ngIf="isFieldInvalid('dob')">
      <wes-form-field-error *ngIf="controls.dob.errors.invalidDate">
        {{ pageContent.dob.inputError }}
      </wes-form-field-error>
      <wes-form-field-error *ngIf="controls.dob.errors.tooYoungOrTooOld">
        {{ pageContent.dob.inputOtherError }}
      </wes-form-field-error>
    </wes-error>
  </div>

  <div class="form-group">
    <label for="profession" data-test="txtProfession">{{
      pageContent.profession.inputLabel
    }}</label>
    <select
      class="form-control"
      formControlName="profession"
      name="profession"
      data-test="ddProfession"
    >
      <option
        *ngFor="let marketSegment of marketSegmentList$ | async"
        value="{{ marketSegment.value }}"
        >{{ marketSegment.description }}</option
      >
    </select>
    <ng-container *ngIf="isFieldInvalid('profession')">
      <span *ngIf="controls.profession.errors.required">
        {{ pageContent.profession.inputError }}
      </span>
    </ng-container>
  </div>

  <wes-form-field>
    <wes-label data-test="lblNino">{{
      pageContent.niNumber.inputLabel
    }}</wes-label>
    <input
      wesInput
      type="text"
      formControlName="nationalInsuranceNumber"
      data-test="txtNino"
    />
    <wes-error *ngIf="isFieldInvalid('nationalInsuranceNumber')">
      <wes-form-field-error>{{
        pageContent.niNumber.inputError
      }}</wes-form-field-error></wes-error
    >
  </wes-form-field>

  <div class="form-group">
    <label for="nationality" data-test="lblNationality">{{
      pageContent.nationality.inputLabel
    }}</label>
    <select
      class="form-control"
      formControlName="nationality"
      name="nationality"
      data-test="ddNationality"
    >
      <option
        *ngFor="let nationality of nationalityList$ | async"
        value="{{ nationality.value }}"
        >{{ nationality.description }}</option
      >
    </select>

    <ng-container *ngIf="isFieldInvalid('nationality')">
      <span *ngIf="controls.nationality.errors.required">
        {{ pageContent.nationality.inputError }}
      </span>
    </ng-container>
  </div>

  <h3>{{ pageContent.addressDetails.heading }}</h3>
  <span [innerHTML]="pageContent.addressDetails.summary"></span>
  <wes-address-lookup-form
    *ngIf="!isManualAddressVisible"
    formControlName="addressLookup"
    [touched]="controls.addressLookup.touched"
    [submitAttempt$]="submitAttempt$"
    (searchedAddress)="onFindPostcode($event)"
    (selectedAddress)="onSelectedAddress($event)"
    (showManualAddress)="onShowManualAddress($event)"
  ></wes-address-lookup-form>

  <button
    *ngIf="isManualAddressVisible"
    type="button"
    class="wes-button wes-button-link"
    (click)="onShowAddressLookup()"
    data-test="btnShowFindAddress"
  >
    {{ pageContent.addressDetails.findAddress }}
  </button>
  <wes-manual-address-form
    [style.display]="isManualAddressVisible ? 'block' : 'none'"
    formControlName="manualAddress"
    [touched]="controls.manualAddress.touched"
    [submitAttempt]="submitAttempt$ | async"
  ></wes-manual-address-form>

  <h3>{{ pageContent.contactDetails.heading }}</h3>

  <wes-form-field>
    <wes-label data-test="lblPersonalEmail">{{
      pageContent.contactDetails.personalEmail.inputLabel
    }}</wes-label>
    <input
      wesInput
      type="email"
      formControlName="personalEmail"
      autocomplete="email"
      data-test="txtPersonalEmail"
    />
    <wes-error
      *ngIf="
        controls.personalEmail.invalid &&
        (showOverallError ||
          controls.personalEmail.dirty ||
          controls.personalEmail.touched)
      "
    >
      <wes-form-field-error>{{
        pageContent.contactDetails.personalEmail.inputError
      }}</wes-form-field-error></wes-error
    >
  </wes-form-field>

  <wes-form-field>
    <wes-label data-test="lblPersonalMobileNumber">{{
      pageContent.contactDetails.mobileNumber.inputLabel
    }}</wes-label>
    <input
      wesInput
      type="text"
      formControlName="personalMobileNumber"
      autocomplete="tel"
      data-test="textPersonalMobileNumber"
    />
    <wes-error
      *ngIf="
        controls.personalMobileNumber.invalid &&
        (showOverallError ||
          controls.personalMobileNumber.dirty ||
          controls.personalMobileNumber.touched)
      "
    >
      <wes-form-field-error>{{
        pageContent.contactDetails.mobileNumber.inputError
      }}</wes-form-field-error></wes-error
    >
  </wes-form-field>

  <div class="mb-4" [innerHTML]="pageContent.marketing.heading"></div>

  <div class="mb-3">
    <wes-checkbox
      formControlName="marketingEmail"
      class="d-block mb-2"
      labelTestId="lblMarketingEmail"
      inputTestId="cbMarketingEmail"
      >{{ pageContent.marketing.email }}</wes-checkbox
    >
    <wes-checkbox
      formControlName="marketingPhone"
      class="d-block mb-2"
      labelTestId="lblMarketingPhone"
      inputTestId="cbMarketingPhone"
      >{{ pageContent.marketing.phone }}</wes-checkbox
    >
    <wes-checkbox
      formControlName="marketingPost"
      class="d-block"
      labelTestId="lblMarketingPost"
      inputTestId="cbMarketingPost"
      >{{ pageContent.marketing.post }}</wes-checkbox
    >
  </div>
  <div [innerHTML]="pageContent.privacy"></div>

  <button
    class="wes-button wes-button-primary d-block w-100 w-md-auto mt-5 mt-md-6"
    type="submit"
    data-test="btnContinue"
  >
    Continue
  </button>
</form>

<!-- <pre>
    Valid FULL FORM: {{ form.valid | json }}
    Valid Lookup {{ form.controls.addressLookup.valid }}
    Valid Manual {{ form.controls.manualAddress.valid }}
    Show BigO {{ showOverallError }}
    {{ form.value | json }}
</pre> -->
